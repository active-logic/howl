⊐ NUnit.Framework;
⊐ Active.Howl;

⊓ Unit{
‒ ○ CLI_Test : TestBase{

    ᴸ ㄹ publishPath = "netcoreapp3.1/osx-x64/publish";

    CLI ι;

    ⍜ Setup(){ ι = ⌢ CLI(dry: ✗); MkProj(); }

    ⍉ Teardown ⎚ DelProj();

    // ==============================================================

    // Ensure no-arg run displays version number and doc
    ؟ Main ⎚ CLI.Main(⌢ ㄹ[]{});

    // --------------------------------------------------------------

    ؟ Build(){
        ι.Build(∅, "Mudbox");
        ∃( "Mudbox/build/Main.sln",
           "Mudbox/build/src/Main.cs",
           "Mudbox/build/src/src.csproj",
           "Mudbox/build/src/bin/Debug",
           "Mudbox/build/src/obj/Debug" );
    }

    // TODO - Install is platform specific and so is the test
    /* QUARANTINE (n/a on nix)
    ؟ Install(){
        ι.Install(∅, "Mudbox");
        ∃( $"Mudbox/build/src/bin/Release/{publishPath}/src",
            "/usr/local/bin/mudbox" );
        o( Runner.Cmd("foobar", "", workdir: "/", dry: ✗) ≠ 0 );
        o( Runner.Cmd("mudbox", "", workdir: "/", dry: ✗) ☰ 0 );
        // Clean
        $"Mudbox/build/src/bin".RmDir(dry: ✗);
        $"/usr/local/bin/mudbox".JustDelete(dry: ✗);
    }
    */

    ؟ Publish(){
        ι.Publish(∅, "Mudbox");
        ∃( $"Mudbox/build/src/bin/Debug/{publishPath}/src" );
    }

    // TODO differentiate `Run` from `Build`
    ؟ Run(){
        o(ι.Build(∅, "Mudbox"), 0);
        ∃( "Mudbox/build/Main.sln",
           "Mudbox/build/src/Main.cs",
           "Mudbox/build/src/src.csproj",
           "Mudbox/build/src/bin/Debug",
           "Mudbox/build/src/obj/Debug" );
    }

    // TODO - Check tests actually build and run
    ؟ Test(){
        ι.Test(∅, "Mudbox");
        ∃( "Mudbox/build/src",
           "Mudbox/build/test",
           "Mudbox/build/Main.sln",
           "Mudbox/build/src/src.csproj",
           "Mudbox/build/test/test.csproj" );
    }

    // --------------------------------------------------------------

    ؟ Export(){
        o( ι.Export(∅, "Mudbox/src", "Mudbox/build"),
           "Exported Main.howl");
        ∃( "Mudbox/build/Main.cs" );
    }

    // ==============================================================

    ┈ MkProj(){
        "Mudbox/src".MkDir();
        "Mudbox/src/Main.howl".Write("‒○ Bar{∘ ┈ Main(ㄹ[] args){}}");
    }

    ┈ DelProj(){
        // Cleaning everything takes too long because of dotnet new
        // "MudBox".RmDir(dry: ✗);
        ⤴ ( !"MudBox".IsDir() ) ⮐ ;
        "MudBox".DeleteFiles("*.cs", withMetaFile: ✗);
        "MudBox".DeleteFiles("*.howl", withMetaFile: ✗);
    }

}}

âŠ System; âŠ Ex = System.Exception;
âŠ DNT = Active.Howl.DotNetTemplates;
âŠ System.Linq;

âŠ“ Active.Howl{
â€’ â—‹ Builder{

    DotNet Î´ = âŒ¢ DotNet();

    â€’ á† Build(ã„¹ Ï€){
        Update(Ï€);
        â® Î´.Build("-v quiet --nologo", $"{Ï€}/build", dry: âœ—);
    }

    â€’ á† Install(ã„¹ Ï€, ã…‡ addToPath = âœ“)
    â†’ OS.isWindows ? InstallWin(Ï€, addToPath)
                   : InstallNix(Ï€, addToPath);

    â€’ á† Publish(ã„¹ Ï€, ã„¹ config = "Debug", ã„¹ rt = âˆ…){
        Update(Ï€);
        â® Î´.Publish($"src -c {config} --nologo", $"{Ï€}/build",
                     rt, dry: âœ—);
    }

    â€’ á† Run(ã„¹ Ï€)
    { Update(Ï€); â® Î´.Run("--project src", $"{Ï€}/build", dry: âœ—); }

    â€’ á† Test(ã„¹ Ï€){ Update(Ï€);  â® Î´.Test($"{Ï€}/build", dry: âœ—); }

    // ---------------------------------------------------------------

    â€’ á† InstallNix(ã„¹ Ï€, ã…‡ addToPath){
        âˆ™ rt = OS.runtime;
        âˆ™ ã„¸ = Publish(Ï€, config: "Release", rt);
        â¤´ (ã„¸ != 0){ ğŸ¦ "Install: Publish failed ({ã„¸})"; â® ã„¸; }
        âˆ™ path =
           $"{Ï€}/build/src/bin/Release/netcoreapp3.1/{rt}/publish";
        âˆ™ link =
           $"/usr/local/bin/{ExeName(Ï€)}";
        â¤´ (!path.Exists()) (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("Binaries path is invalid");
        â¤³ (!addToPath) â® ã„¸;
        ã„¸ = Runner.Cmd(
            "ln", $"-sf {path.FullPath()}/src {link}", Ï€, dry: âœ—);
        â¤´ (ã„¸ != 0){ ğŸ¦ "Install: symlink failed ({ã„¸})"; }
        â® ã„¸;
    }

    â€’ á† InstallWin(ã„¹ Ï€, ã…‡ addToPath){
        Update(Ï€);
        ã„¹ args = "-c Release --nologo", proj = ProjectName(Ï€);
        âˆ™ ã„¸ = Î´.Publish(
            $"src {args} -o \"C:/Program Files/{proj}\"",
            $"{Ï€}/build", rt: âˆ…, dry: âœ—);
        âˆ™ path = $"C:/Program Files/{proj}";
        â¤´ (!$"{path}/src.exe".Exists())
                            (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("Binaries path is invalid");
        â¤³ (!addToPath) â® ã„¸;
        // TODO Update path in $profile
        âˆ™ profile = Environment.GetEnvironmentVariable("profile");
        â¤´ (ã„¹.IsNullOrEmpty(profile)){
            ğŸ¤ $"User profile not found; Cannot add {ExeName(Ï€)} to "
              + "the path";
            â® 2;
        }
        ğŸ° $"PROFILE: {profile}";
        âˆ™ Î› = profile.ReadLines();
        âˆ™ pathEntry = $"$env:Path += ';c:/PROGRA~1/{proj}'";
        â¤´ (!Î›.Contains(pathEntry))
            profile.Write(Î› + "\n" + pathEntry);
        â® ã„¸;
    }

    â€’ ã„¹ ProjectName(ã„¹ Ï€)
    { âˆ™ Î  = Ï€.FullPath(); â® Î .Substring(Î .LastIndexOf("/") + 1); }

    â€’ ã„¹ ExeName(ã„¹ Ï€) â†’ ProjectName(Ï€).ToLower();

    â€’ á† Update(ã„¹ Ï€){
        âˆ™ Î² = $"{Ï€}/build";
        â¤´ ( Î².âˆƒ() ) Î².DeleteFiles("*.cs", withMetaFile: âœ—);
        Export(âˆ…, $"{Ï€}/src", $"{Î²}/src");
        Export(âˆ…, $"{Ï€}/test", $"{Î²}/test");
        â® Solution(Î², dry: âœ—);
    }

    // TRANSITIONAL
    â€’ ã„¹ Export(â‹¯ ã„¹[] ã…‚){
        ã…‡ dry = âœ—;
        ã„¹ src = ã…‚[1].WithFinalSep(),
          dst = ã…‚[2].WithFinalSep();
        â¤´ (!src.IsDir()) â® $"Source dir not found: {src}\n";
        âˆ™ paths = FileSystem.Paths(src, "*.howl");
        â¤´ (dry){
            â® âˆ…;
        }
        âˆ€ (âˆ™ x âˆˆ paths){
            âˆ™ y = dst + x.RelativeTo(src).SetExtension(".cs");
            ğŸ°y;
            Howl.BuildFile(x, y);
        }
        â® "Exported some files";
    }

    â€’ á† Solution(ã„¹ Ï€, ã…‡ dry){
        á† ã„¸ = 0;
        â¤´ (!$"{Ï€}/Main.sln".âˆƒ()){
            Ï€.MkDir();
            ã„¸ = Î´.New($"solution --force -n Main", Ï€, âˆ…, dry);
            $"{Ï€}/src/src.csproj".Write(DNT.Console, mkdir: true);
            $"{Ï€}/test/test.csproj".Write(DNT.NUnit, mkdir: true);
            ã„¸ = Î´["sln add",
               "src/src.csproj test/test.csproj", Ï€, dry];
        } â® ã„¸;
    }

    â€’ á† SlowSolution(ã„¹ Ï€, ã…‡ dry){
        á† ã„¸ = 0;
        â¤´ (!$"{Ï€}/Main.sln".âˆƒ()){
            Ï€.MkDir();
            âˆ™ opts = "--force --no-restore";
            // NOTE: dotnet [new solution | sln | add ] do not accept
            // --no-restore
            ã„¸ = Î´.New($"solution --force -n Main", Ï€, âˆ…, dry);
            ã„¸ = Î´.New($"console {opts} -n src", Ï€, âˆ…, dry);
            ã„¸ = Î´.New($"nunit {opts} -n test", Ï€, âˆ…, dry);
            $"{Ï€}/src/Program.cs".JustDelete(dry);
            // This is for libraries
            // $"{Ï€}/src/Class1.cs".JustDelete(dry);
            $"{Ï€}/test/UnitTest1.cs".JustDelete(dry);
            ã„¸ = Î´["add",
                "test/test.csproj reference src/src.csproj", Ï€, dry];
            ã„¸ = Î´["sln add",
               "src/src.csproj test/test.csproj", Ï€, dry];
        } â® ã„¸;
    }

}}

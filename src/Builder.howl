âŠ System; âŠ Ex = System.Exception;
âŠ System.Linq;

âŠ“ Active.Howl{
â€’ â—‹ Builder{

    DotNet Î´ = âŒ¢ DotNet();

    â€’ ã…‡ Build(ã„¹ Ï€)
    â†’ Update(Ï€) âˆ§ Î´.Build("-v quiet --nologo", $"{Ï€}/build", dry: âœ—);

    â€’ ã…‡ Install(ã„¹ Ï€, ã…‡ addToPath = âœ“)
    â†’ OS.isWindows ? InstWin(Ï€, addToPath) : InstNix(Ï€, addToPath);

    â€’ ã…‡ Publish(ã„¹ Ï€, ã„¹ config = "Debug", ã„¹ rt = âˆ…)
    â†’ Update(Ï€) âˆ§ Î´.Publish($"src -c {config} --nologo", $"{Ï€}/build",
                            rt, dry: âœ—);

    â€’ ã…‡ Run(ã„¹ Ï€)
    â†’ Update(Ï€) âˆ§ Î´.Run("--project src", $"{Ï€}/build", dry: âœ—);

    â€’ ã…‡ Test(ã„¹ Ï€)
    â†’  Update(Ï€) âˆ§ Î´.Test($"{Ï€}/build", dry: âœ—);

    // ---------------------------------------------------------------

    â€’ ã…‡ InstNix(ã„¹ Ï€, ã…‡ addToPath){
        âˆ™ rt = OS.runtime;
        âˆ™ ã„¸ = Publish(Ï€, config: "Release", rt);
        â¤´ (!ã„¸){ ğŸ¦ "Install: Publish failed ({ã„¸})"; â¤¬ }
        âˆ™ path =
           $"{Ï€}/build/src/bin/Release/netcoreapp3.1/{rt}/publish";
        âˆ™ link =
           $"/usr/local/bin/{ExeName(Ï€)}";
        â¤´ (!path.Exists()) (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("Binaries path is invalid");
        â¤³ (!addToPath) â® ã„¸;
        ã„¸ = Runner.Cmd("ln", $"-sf {path.FullPath()}/src {link}",
                        Ï€, dry: âœ—) == 0;
        â¤´ (!ã„¸) ğŸ¦ "Install: symlink failed ({ã„¸})";
        â® ã„¸;
    }

    â€’ ã…‡ InstWin(ã„¹ Ï€, ã…‡ addToPath){
        Update(Ï€);
        ã„¹ args = "-c Release --nologo", proj = ProjectName(Ï€);
        âˆ™ ã„¸ = Î´.Publish(
            $"src {args} -o \"C:/Program Files/{proj}\"",
            $"{Ï€}/build", rt: âˆ…, dry: âœ—);
        â¤´ (!ã„¸){ ğŸ¦ "Install: Publish failed ({ã„¸})"; â¤¬ }
        âˆ™ path = $"C:/Program Files/{proj}";
        â¤´ (!$"{path}/src.exe".Exists())
                            (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("Binaries path is invalid");
        â¤³ (!addToPath) â® ã„¸;
        // TODO Update path in $profile
        âˆ™ profile = Environment.GetEnvironmentVariable("profile");
        â¤´ (ã„¹.IsNullOrEmpty(profile)){
            ğŸ¤ $"User profile not found; Cannot add {ExeName(Ï€)} to "
              + "the path";
            â¤¬
        }
        ğŸ° $"PROFILE: {profile}";
        âˆ™ Î› = profile.ReadLines();
        âˆ™ pathEntry = $"$env:Path += ';c:/PROGRA~1/{proj}'";
        â¤´ (!Î›.Contains(pathEntry))
            profile.Write(Î› + "\n" + pathEntry);
        â® ã„¸;
    }

    â€’ ã„¹ ProjectName(ã„¹ Ï€)
    { âˆ™ Î  = Ï€.FullPath(); â® Î .Substring(Î .LastIndexOf("/") + 1); }

    â€’ ã„¹ ExeName(ã„¹ Ï€) â†’ ProjectName(Ï€).ToLower();

    â€’ ã…‡ Update(ã„¹ Ï€){
        ã„¹ src = $"{Ï€}/src", test = $"{Ï€}/test", build = $"{Ï€}/build";
        â¤´ (!src.âˆƒ()){ ğŸ¦$"{src} not found"; â¤¬ }
        â¤´ ( build.âˆƒ() ) build.DeleteFiles("*.cs", withMetaFile: âœ—);
        Export(âˆ…, src, $"{build}/src");
        Export(âˆ…, test, $"{build}/test");
        â® âŒ¢ Project().Solution(build, dry: âœ—);
    }

    // TRANSITIONAL
    â€’ ã„¹ Export(â‹¯ ã„¹[] ã…‚){
        ã…‡ dry = âœ—;
        ã„¹ src = ã…‚[1].WithFinalSep(),
          dst = ã…‚[2].WithFinalSep();
        â¤´ (!src.IsDir())
            â® $"Source dir not found: {src}\n";
        âˆ™ paths = FileSystem.Paths(src, "*.howl");
        â¤´ (dry)
            â® âˆ…;
        âˆ€ (âˆ™ x âˆˆ paths){
            âˆ™ y = dst + x.RelativeTo(src).SetExtension(".cs");
            Howl.BuildFile(x, y);
        }
        â® "Exported some files";
    }

}}

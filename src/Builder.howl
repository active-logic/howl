âŠ Ex = System.Exception;

âŠ“ Active.Howl{
â€’ â—‹ Builder{

    DotNet Î´ = âŒ¢ DotNet();

    â€’ á† Build(ã„¹ Ï€){
        Update(Ï€); â® Î´.Build("-v quiet", $"{Ï€}/build", dry: âœ—);
    }

    â€’ á† Publish(ã„¹ Ï€, ã„¹ config = "Debug", ã„¹ rt = âˆ…){
        Update(Ï€);
        â® Î´.Publish($"src -c {config} --nologo", $"{Ï€}/build",
                     rt, dry: âœ—);
    }

    â€’ á† Run(ã„¹ Ï€){
        Update(Ï€);  â® Î´.Run("src --nologo", $"{Ï€}/build", dry: âœ—);
    }

    â€’ á† Test(ã„¹ Ï€){
        Update(Ï€);  â® Î´.Test($"{Ï€}/build", dry: âœ—);
    }

    â€’ á† Install(ã„¹ Ï€){
        âˆ™ rt = OS.runtime;
        â¤´ (rt â‰  "osx-x64"){
            ğŸ° $"N/A: 'install' ({rt})";
            â® 1;
        }
        Publish(Ï€, config: "Release", rt);
        âˆ™ path =
           $"{Ï€}/build/src/bin/Release/netcoreapp3.1/osx-x64/publish";
        âˆ™ link =
           $"/usr/local/bin/{ProjectName(Ï€)}";
        â¤´ (!path.Exists()) (â•¯Â°â–¡Â°)â•¯
                                 âŒ¢ Ex("Binaries path is invalid");
        â® Runner.Cmd(
            "ln", $"-sf {path.FullPath()}/src {link}",
            Ï€, dry: âœ—);
    }

    // ---------------------------------------------------------------

    â€’ ã„¹ ProjectName(ã„¹ Ï€){
        âˆ™ Î  = Ï€.FullPath();
        â® Î .Substring(Î .LastIndexOf("/") + 1).ToLower();
    }

    á† Update(ã„¹ Ï€){
        Export(âˆ…, $"{Ï€}/src", $"{Ï€}/build/src");
        Export(âˆ…, $"{Ï€}/test", $"{Ï€}/build/test");
        â® Solution($"{Ï€}/build", dry: âœ—);
    }

    // TRANSITIONAL
    â€’ ã„¹ Export(â‹¯ ã„¹[] ã…‚){
        ã…‡ dry = âœ—;
        ã„¹ src = ã…‚[1].WithFinalSep(),
          dst = ã…‚[2].WithFinalSep();
        â¤´ (!src.IsDir()) â® $"Source dir not found: {src}\n";
        âˆ™ paths = FileSystem.Paths(src, "*.howl");
        â¤´ (dry){
            â® âˆ…;
        }
        âˆ€ (âˆ™ x âˆˆ paths){
            âˆ™ y = dst + x.RelativeTo(src).SetExtension(".cs");
            ğŸ°y;
            Howl.BuildFile(x, y);
        }
        â® "Exported some files";
    }

    â€’ á† Solution(ã„¹ Ï€, ã…‡ dry){
        á† ã„¸ = 0;
        â¤´ (!$"{Ï€}/Main.sln".âˆƒ()){
            Ï€.MkDir();
            ã„¸ = Î´.New("solution --name Main --force", Ï€, âˆ…, dry);
            ã„¸ = Î´.New("console --name src --force", Ï€, âˆ…, dry);
            ã„¸ = Î´.New("nunit --name test --force", Ï€, âˆ…, dry);
            $"{Ï€}/src/Class1.cs".JustDelete(dry);
            $"{Ï€}/test/UnitTest1.cs".JustDelete(dry);
            ã„¸ = Î´["add",
                "test/test.csproj reference src/src.csproj", Ï€, dry];
            ã„¸ = Î´["sln add",
               "src/src.csproj test/test.csproj", Ï€, dry];
        } â® ã„¸;
    }

}}

âŠ System.Collections.Generic;
âŠ Ex = System.Exception; âŠ InvOp = System.InvalidOperationException;
#if UNITY_EDITOR
âŠ UnityEngine; âŠ UnityEditor;
âŠ S = Active.Howl.Messages;
#endif
âŠÌ¥ Active.Howl.Path ;

âŠ“ Active.Howl{
â€’Ì¥ â—‹ Howl{

    â€’Ì¥ ã…‡ warnings = âœ“;
    âˆ˜ Map map = Map.@default;

    // --------------------------------------------------------------

    #if UNITY_EDITOR

    â€’Ì¥ â”ˆ ExportAll(){
        ğŸ° "Convert *.howl scripts to C# ã€œ (;Ï‰;)";
        ExportDir("Assets/", verbose: âœ“);
    }

    â€’Ì¥ â”ˆ ImportAll(){
        ğŸ° "Convert *.cs scripts to Howl ã€œ (â•¯Â°â–¡Â°)â•¯ âŒ¢ C#";
        ImportDir("Assets/", verbose: âœ“);
    }

    â€’Ì¥ â”ˆ ReApply(){
        ğŸ° "Apply notation";
        FileSystem.Paths(Path.howlRoot, "*.howl")
                  .ForEach(ReimportFile);
    }

    â€’Ì¥ â”ˆ Refresh(){
        ğŸ° "Refresh";
        Rebuild(quick: âœ“);
    }

    â€’Ì¥ â”ˆ Rebuild(){
        ğŸ° "Rebuild";
        // Do not delete metafiles on rebuild or scene scripts unbind
        Path.buildRoot.DeleteFiles("*.cs", withMetaFile: âœ—);
        Rebuild(quick: âœ—);
    }

    â€’Ì¥ â”ˆ Rebuild(ã…‡ quick){
        âˆ€ (âˆ™ x âˆˆ FileSystem.Paths(Path.howlRoot, "*.howl")){
            â¤´(!quick âˆ¨ x.DateModified() > Config.Î¹.lastExportDate){
                ğŸ° $"Building {x.FileName()}";
                BuildFile(x);
            }
        } AssetDatabase.Refresh();
    }

    #endif

    // --------------------------------------------------------------

    â€’Ì¥ â”ˆ BuildFile(ã„¹ ã…‚){
        â¤´ (!ã…‚.IsHowlSource())
            ğŸ”¸($"{ã…‚} should be under {howlRoot}...");
        â¤µ BuildFile(ã…‚, ã…‚.BuildPath());
    }

    â€’Ì¥ ã„¹ BuildFile(ã„¹ ã…‚, ã„¹ ã„¸){
        ã„¹ x = ã…‚.Read();
        â¤´ (x.StartsWith(cerberusWard)) â® DismissCerberus(x, ã„¸);
        ã„¹ y = ExportAsIs(x) ? x : x * map;
        ã„¸?.Write(y, date: ã…‚.DateModified());
        â® y;
    }

    // --------------------------------------------------------------

    // TODO - from Builder.howl, compared to other methods, somewhat
    // different contract
    â€’Ì¥ ã…‡ Export(ã„¹ src, ã„¹ dst){
        src = src.WithFinalSep();
        dst = dst.WithFinalSep();
        â¤´ (!src.IsDir()){ ğŸ°$"Source dir not found: {src}\n"; â¤¬ }
        âˆ™ paths = FileSystem.Paths(src, "*.howl");
        âˆ€ (âˆ™ x âˆˆ paths){
            âˆ™ y = dst + x.RelativeTo(src).SetExtension(".cs");
            Howl.BuildFile(x, y);
        } ã†‘
    }

    â€’Ì¥ â”ˆ ExportDir(ã„¹ Ï€, ã…‡ verbose=âœ—)
    â†’ FileSystem.Paths(Ï€, "*.howl", "*.asmdt").ForEach(ExportFile);

    â€’Ì¥ â”ˆ ExportFile(ã„¹ Ï€){
        #if UNITY_EDITOR
        â¤´ (!Config.Î¹.allowExport) (â•¯Â°â–¡Â°)â•¯âŒ¢ Ex(S.EnableExport);
        #endif
        ExportFile(Ï€, dry: âœ—);
    }

    â€’Ì¥ ã„¹ ExportFile(ã„¹ Ï€, ã…‡ dry){
        â¤´ (Ï€.TypeIs(_Asmdt)) â® ExportAssemblyDefToken(Ï€, dry);
        âˆ™ Ïƒ = Ï€.SetExtension(Path._Cs);
        BuildFile(Ï€, dry ? âˆ… : Ïƒ);
        âˆ™ Î¸ = Ïƒ.BuildPath();
        â¤´ (!dry){
            â¤´ (Î¸.Exists()){
                Î¸.Delete(withMetaFile: âœ—);
                âˆ™ m0 = Î¸.MetaFile();
                âˆ™ m1 = Ïƒ.PathToMetaFile();
                â¤´ (m0 â‰  âˆ…) System.IO.File.Move(m0, m1);
            }
            Ï€.Delete(withMetaFile: âœ“);
        }
        â® dry ? $"Export\n{Ï€} as\n{Ïƒ} and move it to\n{Î¸}" : âˆ…;
    }

    â€’Ì¥ ã„¹ ExportAssemblyDefToken(ã„¹ Ï€, ã…‡ dry){
        âˆ™ Ïƒ = Ï€.SetExtension(Path._Asmdef);
        âˆ™ Î¸ = Ïƒ.BuildPath();
        â¤´ (!dry){
            Î¸.MoveTo(Ïƒ, withMetaFile: âœ“);
            Ï€.Delete(withMetaFile: âœ“);
        }
        â® dry ? $"Rename {Î¸} to\n{Ïƒ}\nand delete {Ï€}" : âˆ…;
    }

    // --------------------------------------------------------------

    â€’Ì¥ ğ•ƒ<ã„¹> ImportDir(ã„¹ ã…‚, ã„¹ ext= "*.cs", ã…‡ dry = âœ—, ã…‡ verbose = âœ—){
        âˆ™ conflicts = âŒ¢ ğ•ƒ<ã„¹>();
        âˆ€ (âˆ™ Ï€ âˆˆ FileSystem.Paths(ã…‚, ext, "*.asmdef")){
            â¤´ (Ï€.In(Path.buildRoot)) continue;
            â†¯ {
                ImportFile(Ï€, dry);
            } â‡¤ (InvOp ex){
                conflicts.Add($"{Ï€} has conflicts\n{ex.Message}");
            }
        }
        â¤´ (conflictsâ > 0 âˆ§ verbose) âˆ€ (âˆ™ k âˆˆ conflicts) ğŸ¦ k;
        â® conflicts;
    }

    â€’Ì¥ â”ˆ ImportFile(ã„¹ Ï€){
        #if UNITY_EDITOR
        â¤´ (!Config.Î¹.allowImport) (â•¯Â°â–¡Â°)â•¯âŒ¢ Ex(S.EnableImport);
        #endif
        ImportFile(Ï€, dry: âœ—);
    }

    â€’Ì¥ ã„¹ ImportFile(ã„¹ Ï€, ã…‡ dry){
        â¤´ (Ï€.TypeIs(Path._Asmdef)) â® ImportAssemblyDefToken(Ï€, dry);
        âˆ™ Ïƒ = Ï€.SetExtension(Path._Howl);
        ImportFile(Ï€, dry ? âˆ… : Ïƒ);
        âˆ™ Î¸ = Ïƒ.BuildPath();
        â¤´ (!dry) Ï€.MoveTo(Î¸, withMetaFile: âœ“);
        â® dry ? $"Import\n{Ï€} as\n{Ïƒ} and move it to\n{Î¸}" : âˆ…;
    }

    â€’Ì¥ ã„¹ ImportAssemblyDefToken(ã„¹ Ï€, ã…‡ dry){
        âˆ™ Ïƒ = Ï€.SetExtension(Path._Asmdt);
        âˆ™ Î¸ = Ï€.BuildPath();
        â¤´ (!dry){
            Ï€.MoveTo(Î¸, withMetaFile: âœ“);
            Ïƒ.Write("Assembly def token\n");
        }
        â® dry ? $"Rename {Ï€} to\n{Î¸}\nand create {Ïƒ}" : âˆ…;
    }

    â€’Ì¥ ã„¹ ImportFile(ã„¹ ã…‚, ã„¹ ã„¸){
        ã„¹ y = ImportString(ã…‚.Read(), fromPath: ã…‚);
        ã„¸?.Write(y, date: ã…‚.DateModified());
        â® y;
    }

    â€’Ì¥ ã„¹ ImportString(ã„¹ x, ã„¹ fromPath=âˆ…){
        ã„¹ y = ImportAsIs(x) ? x : x / map;
        â¤´ ( x â‰  y * map){
            y = WithCerberusWard(x);
            â¤´ (fromPath â‰  âˆ…) ğŸ¤ $"{Wards.Cerberus} ã€œ {fromPath}";
        }
        â® y;
    }

    // --------------------------------------------------------------

    // TODO ensure no double nitpick
    â€’Ì¥ ã„¹ NitPick(ã„¹ ã…‚, ã„¹ ã„¸ = âˆ…, ã…‡ force = âœ—){
        ã„¹ x = ã…‚.Read();
        ã„¹ y = (NitPickAsIs(x) âˆ§ !force) ? x : x % map;
        â¤´ (x â‰  y) (ã„¸ ?? ã…‚).Write(y);
        â® y;
    }

    // --------------------------------------------------------------

    â€’Ì¥ â”ˆ ReimportFile(ã„¹ Ï€){ ReimportFile(Ï€, âœ—); }

    â€’Ì¥ ã„¹ ReimportFile(ã„¹ Ï€, ã…‡ dry){
        ã„¹ e = BuildFile(Ï€, âˆ…);
        ã„¹ ã„¸ = ImportString(e);
        â¤´ (!dry) Ï€.Write(ã„¸);
        â® ã„¸;
    }

    // --------------------------------------------------------------

    â€’Ì¥ ã„¹ DismissCerberus(ã„¹ x, ã„¹ ã„¸){
        âŸ² (x.StartsWith(cerberusWard))
            x = x.Substring(cerberusWardâ™);
        ã„¸?.Write(x, mkdir: âœ“, importAsset: âœ“);
        â® x;
    }

    â€’Ì¥ ã…‡ ExportAsIs(ã„¹ x) â†’ x.âˆ‹(Wards.Cerberus);

    â€’Ì¥ ã…‡ ImportAsIs(ã„¹ x) â†’ x.âˆ‹(Wards.GardenOfEden) âˆ¨ x.âˆ‹(Wards.Tengu);

    â€’Ì¥ ã…‡ NitPickAsIs(ã„¹ x) â†’ ImportAsIs(x) âˆ¨ ExportAsIs(x);

    â€’Ì¥ ã„¹ WithCerberusWard(ã„¹ x)
    â†’ x.StartsWith(cerberusWard) ? x : cerberusWard + x;

    â€’Ì¥ ã„¹ cerberusWard â†’ Wards.Cerberus.Comment();

}}

âŠ System.Linq; âŠ System.Text;

âŠ“ Active.Howl{
â€’Ì¥ â—‹ WhiteSpaceAdder{

    âˆ˜ á† index;
    âˆ˜ ã„¹ ã…‚;

    â€’Ì¥ ã„¹ Consolidate(â¦¿ ã„¹ ã…‚, á†©[] S){
        index = 0;
        WhiteSpaceAdder.ã…‚ = ã…‚;
        â® (â€– c âˆˆ ã…‚ á¥ Consolidate(c, S))à§´.Join();
    }

    â€’Ì¥ string Consolidate(this string x, string[] S){
        var @out = new StringBuilder();
        for(int i = 0; i < xâ™; i++){
            bool didMatch = false;
            foreach(var s in S){
                var n = sâ™;
                if(x.Matches(s, at: i)){
                    @out.Append(s);
                    if(i + n < xâ™
                                âˆ§ !IsBreakingChar(x[i + n])){
                        @out.Append(' ');
                    }
                    didMatch = true;
                    i += n - 1;  // -1 because iteration adds 1
                    Â¦
                }
            }
            if(!didMatch) @out.Append(x[i]);
        }
        return @outğŸ ;
    }

    // TODO probably also win line endings
    static bool IsBreakingChar(char c){
        return " \n/()\"':,.;<>~!@#$%^&*|+=[]{}`?-â€¦".Contains(c);
    }

    âˆ˜ ã„¹ Consolidate(á†© c, á†©[] S){
        index++;
        âˆ™ ã„¸ = $"{c}";
        â¤´(index â˜° ã…‚â™) â® ã„¸;
        âˆ™ next = ã…‚[index];
        // Check if 'c' is a soft symbol; if not, just return it.
        â¤´(!S.âˆ‹(c)) â® ã„¸;
        // Letter/char after soft symbol needs space; likewise
        // when soft symbols follow in sequence
        â¤´(á†©.IsLetterOrDigit(next)
                  âˆ¨ S.âˆ‹(next)) â® ã„¸ + ' ';
        // Non word char after soft symbol needs no extra space
        â® ã„¸;
    }

}}

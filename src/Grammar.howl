âŠ System.Linq;
âŠ InvOp = System.InvalidOperationException;

âŠ“ Active.Howl{
â€’ â—‹ Grammar{

    // cd to tree-sitter-howl, then:
    // In: grammar.template.js, Out: grammar.js
    â€’Ì¥ ã…‡ Inject(ã„¹ ã…‚, ã„¹ ã„¸){
        ğŸ¥("Injecting grammar template");
        ã„¸.Write(Grammar.Inject(ã…‚.Read(), Map.@default));
        ã†‘
    }

    â€’Ì¥ ã„¹ Inject(ã„¹ jsGram, Map map, ã…‡ raise = âœ“){
        âˆ€(Classifier x âˆˆ Classifier.all){
            âˆ™ tag = Tag(x);
            â¤´(jsGram.âˆ‹(tag)){
                jsGram = jsGram.Replace(tag, Format(x, map));
            }â¤µ{
                jsGram = InjectEach(jsGram, x, map, raise);
            }
        }
        â® jsGram;
    }

    â€’Ì¥ ã„¹ InjectEach(ã„¹ jsGram, Classifier x,
                                    Map map, ã…‡ raise = âœ“){
        âˆ€(Rep rule âˆˆ map.ForClass(x)){
            âˆ™ tag = Tag(rule);
            â¤´(jsGram.âˆ‹(tag)){
                jsGram = jsGram.Replace(tag, $"'{rule.a}'");
            }â¤³(raise) (â•¯Â°â–¡Â°)â•¯
                âŒ¢ InvOp($"Template needs {tag} or {Tag(x)}");
        }
        â® jsGram;
    }

    â€’Ì¥ ã„¹ Tag(Classifier x) â†’ $"__{x}__";

    â€’Ì¥ ã„¹ Tag(Rep x) â†’ $"__%{x.b}%__";

    â€’Ì¥ ã„¹ Format(Classifier x, Map map)
    â†’ (â€– Ï âˆˆ map.ForClass(x) â–¸ $"'{Ï.a}'")
       à§´.Join(", ");

}}

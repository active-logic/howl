âŠ System.Linq; âŠ System.Collections.Generic;
âŠ Ex = System.Exception; âŠ ArgEx = System.ArgumentException;
âŠ Env = System.Environment; âŠ SysPath = System.IO.Path;
âŠ InvOp = System.InvalidOperationException;
#if UNITY_EDITOR
âŠ UnityEditor; âŠ UnityEngine;
#endif

âŠ“ Active.Howl {
â€’Ì¥ â—‹ Path{

    #if UNITY_EDITOR
    âˆ˜ á† frame;
    âˆ˜ ã„¹ cachedBuildRoot;
    #endif

    á´¸ ã„¹ HOWL_ROOT_TOKEN  = "howl.root";
    á´¸ ã„¹ BUILD_ROOT_TOKEN = "howl.build";

    â€’Ì¥ ã„¹ _Howl = ".howl", _Asmdef = ".asmdef",
        _Cs   = ".cs",   _Asmdt = ".asmdt";

    // --------------------------------------------------------------

    â€’Ì¥ â”ˆ AvailHowlRoot(){
        âˆ™ Ï = GetHowlRoot ();
        â¤´ (Ï.didCreate) ğŸ° $"Created Howl root: {Ï.path}";
    }

    â€’Ì¥ ã„¹ Expand(â¦¿ ã„¹ path) â†’ path
    .Replace("~",
        Env.GetFolderPath(Env.SpecialFolder.UserProfile))
    .Replace("%APPDATA%",
        Env.GetFolderPath(Env.SpecialFolder.ApplicationData))
    .Nix();

    â€’Ì¥ ã…‡ HasBuildImage(â¦¿ ã„¹ Ï€){
        â¤´ (Ï€.In(buildRoot) âˆ¨ !Ï€.In(howlRoot)) â® âœ—;
        âˆ™ Î± = buildRoot + Ï€.RelativeTo(howlRoot);
        â¤´ (Î±.TypeIs(_Howl)) Î± = Î±.SetExtension(_Cs);
        â® Î±.Exists();
    }

    â€’Ì¥ ã„¹ FindResourceDir(ã„¹ Ï€){
        ã„¹ x = $"Assets/{Ï€}", y = $"Packages/{Ï€}";
        â® x.Exists() ? x : y.Exists() ? y
           : (â•¯Â°â–¡Â°)â•¯ âŒ¢ ArgEx($"Not in Packages or Assets: {Ï€}");
    }

    â€’Ì¥ ã…‡ TypeIs(â¦¿ ã„¹ Ï€, params ã„¹[] exts){
        âˆ€ (âˆ™ ext âˆˆ exts) â¤´ (Ï€.EndsWith(ext)) â® âœ“;
        â® âœ—;
    }

    â€’Ì¥ ğ•ƒ<ã„¹> GUIDsToPaths(â¦¿ ã„¹[] ã…‚, params ã„¹[] fileTypes){
        #if UNITY_EDITOR
        âˆ™ ã„¸ = âŒ¢ ğ•ƒ<ã„¹>();
        âˆ€ (âˆ™ guid âˆˆ ã…‚){
            âˆ™ Ï€ = AssetDatabase.GUIDToAssetPath(guid);
            â¤´ (Ï€.IsFile()){
                â¤´ (Ï€.TypeIs(fileTypes)) ã„¸.Add(Ï€);
            }â¤³ (Ï€.IsDir()){
                ã„¹[] patterns = (â€– x âˆˆ fileTypes á¥ "*" + x)à§´;
                âˆ€ (âˆ™ x âˆˆ FileSystem.Paths(Ï€, patterns)) ã„¸.Add(x);
            }
        }
        â® âŒ¢ ğ•ƒ<ã„¹>(âŒ¢ ğ•Š<ã„¹>(ã„¸));
        #else
        â® âˆ…;
        #endif
    }

    â€’Ì¥ ã…‡ InAssets(â¦¿ ã„¹ path)
    â†’ path.StartsWith("Assets/") âˆ¨ path.StartsWith("Assets" + '\\');

    â€’Ì¥ ã…‡ In(â¦¿ ã„¹ Ï€, ã„¹ â§•) â†’ Ï€.FullPath().StartsWith(â§•.FullPath());

    // TODO unreliable
    â€’Ì¥ ã…‡ InHowlPath(â¦¿ ã„¹ Ï€) â†’ Ï€.StartsWith(howlRoot);

    â€’Ì¥ ã…‡ IsHowlBound(â¦¿ ã„¹ Ï€) â†’ Ï€.In(buildRoot) ?
                              Ï€.SourcePath().Exists() : âœ—;

    â€’Ì¥ ã…‡ IsBuildRoot(â¦¿ ã„¹ Ï€) â†’ Ï€.FileName() â˜° BUILD_ROOT_TOKEN;

    â€’Ì¥ ã…‡ IsHowlRoot(â¦¿ ã„¹ Ï€) â†’ Ï€.FileName() â˜° HOWL_ROOT_TOKEN;

    â€’Ì¥ ã…‡ IsPackaged(â¦¿ ã„¹ Ï€) â†’ Ï€.StartsWith("Packages/");

    â€’Ì¥ ã…‡ IsDetachedHowlSource(â¦¿ ã„¹ Ï€) â†’ Ï€.EndsWith(_Howl);

    â€’Ì¥ ã…‡ IsAssemblyDefinition(â¦¿ ã„¹ Ï€) â†’ Ï€.TypeIs(_Asmdef);

    â€’Ì¥ ã…‡ IsHowlSource(â¦¿ ã„¹ Ï€) â†’ Ï€.TypeIs(_Howl) âˆ§ Ï€.In(howlRoot);

    â€’Ì¥ ã…‡ IsCSharpSource(â¦¿ ã„¹ Ï€) â†’ Ï€.EndsWith(".cs");

    â€’Ì¥ ã„¹ SetExtension(â¦¿ ã„¹ Ï€, ã„¹ ext) â†’ SysPath.ChangeExtension(Ï€, ext);

    // --------------------------------------------------------------

    // Given path to a C# file or a directory outside the howl path,
    // return matching Howl path
    â€’Ì¥ ã„¹ SourcePath(â¦¿ ã„¹ Ï€){
        Ï€ = howlRoot + Ï€.RelativeTo(buildRoot);
        â® Ï€.TypeIs(_Cs) ? Ï€.SetExtension(_Howl) : Ï€;
    }

    // Given path to howl source or a dir. on Howl path, return the
    // matching C#/export path
    â€’Ì¥ ã„¹ BuildPath(this ã„¹ ã…‚){
        â¤´(!ã…‚.In(howlRoot)) (â•¯Â°â–¡Â°)â•¯ âŒ¢ InvOp($"{ã…‚} not in Howl path");
        ã…‚ = ã…‚.RelativeTo(howlRoot);
        âˆ™ ã„¸ = ã…‚.TypeIs(_Howl) ? ã…‚.SetExtension(_Cs) : ã…‚;
        â® buildRoot + ã„¸;
   }

    // Properties ---------------------------------------------------

    â€’Ì¥ ã…‡ howlRootExists â†’ âœ“;   // FindHowlRoot() â‰  âˆ…;

    â€’Ì¥ ã„¹ assets â†’ "Assets/";

    â€’Ì¥ ã„¹ howlRoot â†’ assets;  // GetHowlRoot().path;

    â€’Ì¥ ã„¹ buildRoot{â•­{
        #if UNITY_EDITOR
        â¤´ (cachedBuildRoot â‰  âˆ… âˆ§ frame â˜° Time.frameCount)
            â® cachedBuildRoot;
        â¤µ {
            frame = Time.frameCount; â® cachedBuildRoot =
                GetRoot(defaultBuildRoot, BUILD_ROOT_TOKEN).path;
        }
        #else
            (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("Do we need 'buildRoot' in CLI?");
            //â® GetRoot(defaultBuildRoot, BUILD_ROOT_TOKEN).path;
        #endif
    }}

    â€’Ì¥ ã„¹ defaultHowlRoot â†’ $"{assets}{projectName}.Howl/";

    â€’Ì¥ ã„¹ defaultBuildRoot â†’ $"{assets}~build";

    // NOTE: App.dataPath uses forward slashes, even on Windows
    â€’Ì¥ ã„¹ projectName{ â•­{
        #if UNITY_EDITOR
        ã„¹[] s = Application.dataPath.Split('/');
        â® s[sâ™ - 2];
        #else
        (â•¯Â°â–¡Â°)â•¯ âŒ¢ Ex("Do we need 'projectName' in CLI?");
        #endif
    }}

    // PRIVATE ------------------------------------------------------

    âˆ˜ (ã„¹ path, ã…‡ didCreate) GetRoot(ã„¹ @default, ã„¹ token
                                               , ã…‡ writeToken = âœ“){
        âˆ™ Ï = FindRoot(token);
        â¤´ (Ï â˜° âˆ…){
            â¤´ (writeToken)$"{@default}/{token}".Write("0", mkdir: âœ“);
            â® (@default, âœ“);
        } â¤µ
            â® (Ï, âœ—);
    }

    â€’Ì¥ ã„¹ FindRoot(ã„¹ token){
        ã„¹ root = FileSystem.Path(assets, token);
        â¤´ (root â˜° âˆ…) â® âˆ…;
        â¤µ {
            âˆ™ dir = root.DirName() + "/";
            á† i = dir.IndexOf(assets);
            â® dir.Substring(i);
        }
    }

    // DEPRECATE - Use GetRoot
    âˆ˜ (ã„¹ path, ã…‡ didCreate) GetHowlRoot(){
        âˆ™ root = FindHowlRoot();
        â¤´ (root â˜° âˆ…){
            root = defaultHowlRoot;
            $"{root}/{HOWL_ROOT_TOKEN}".Write("ROOT", mkdir: âœ“);
            â®  (root, âœ“);
        } â¤µ
            â® (root, âœ—);
    }

    // DEPRECATE - Use FindRoot
    â€’Ì¥ ã„¹ FindHowlRoot(){
        ã„¹ root = FileSystem.Path("Assets/", HOWL_ROOT_TOKEN);
        â¤´ (root â˜° âˆ…) â® âˆ…;
        â¤µ {
            // TODO don't want a sep at end but noticed too late.
            âˆ™ dir = root.DirName() + "/";
            á† i = dir.IndexOf("Assets/");
            â® dir.Substring(i);
        }
    }

}}
